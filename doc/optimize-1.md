# è¿­ä»£ä¼˜åŒ–-1

## ä¸€ã€åŠ¨æ€é…ç½®ï¼ˆå…¨å±€é…ç½®åŠ è½½ï¼‰

### éœ€æ±‚èƒŒæ™¯

åœ¨ RPC æ¡†æ¶è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠåˆ°å¾ˆå¤šé…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒçš„åœ°å€ã€åºåˆ—åŒ–æ–¹å¼ã€ç½‘ç»œç«¯å£å·ç­‰ã€‚å†åŠ ä¸Š RPC æ¡†æ¶æ˜¯éœ€è¦è¢«å…¶ä»–é¡¹ç›®ä½œä¸ºæœåŠ¡æä¾›è€…æˆ–è€…æœåŠ¡æ¶ˆè´¹è€…å¼•å…¥çš„ï¼Œæˆ‘ä»¬åº”å½“å…è®¸æ¡†æ¶çš„é¡¹ç›®é€šè¿‡ç¼–å†™é…ç½®æ–‡ä»¶æ¥**è‡ªå®šä¹‰é…ç½®**ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…éœ€è¦ç¼–å†™ç›¸åŒçš„ RPC é…ç½®ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€å¥—å…¨å±€é…ç½®åŠ è½½åŠŸèƒ½ï¼Œèƒ½å¤Ÿè®© RPC æ¡†æ¶ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªå…¨å±€é…ç½®å¯¹è±¡ï¼Œä¾¿äºæ¡†æ¶å¿«é€Ÿè·å–åˆ°ä¸€æ ·çš„é…ç½®ã€‚

### æ–¹æ¡ˆè®¾è®¡

#### é…ç½®é¡¹æ¢³ç†

å¼€å§‹æ—¶ä¸€åˆ‡ä»ç®€ï¼š

```properties
rpc.name=easy rpc test
rpc.host=localhost
rpc.port=8888
rpc.version=1.0.0
```

åæœŸå¯ä»¥æ‰©å±•ï¼Œé…ç½®é¡¹å‚è€ƒï¼š[Dubbo API é…ç½®](https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/reference-manual/config/api/)

#### è¯»å–é…ç½®æ–‡ä»¶

1ï¼‰é…ç½®æ–‡ä»¶ç±»å‹ï¼š`properties`

2ï¼‰ä½¿ç”¨ `Hutool#Props`

3ï¼‰æ”¯æŒç¯å¢ƒéš”ç¦»

4ï¼‰é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ï¼š`conf/conf.properties` > `conf.properties`ï¼ˆç›¸å¯¹äº classpathï¼‰

```java
/**
  * åŠ è½½é…ç½®
  * <p>
  * ä¼˜å…ˆåŠ è½½ conf/conf.properties, æ‰¾ä¸åˆ°å†åŠ è½½ conf.properties
  *
  * @param clazz  clazz
  * @param prefix properties common prefix
  * @param env    environment
  * @param <T>    T
  * @return props
  */
public static <T> T load(Class<T> clazz, String prefix, String env) {
    T props;
    try {
        props = loadProperties(clazz, "conf/conf", prefix, env);
    } catch (NoResourceException e) {
        log.warn("Not exists conf file in [conf/], will load file from classpath");
        props = loadProperties(clazz, "conf", prefix, env);
    }
    return props;
}
```

#### TODO 

- é…ç½®åˆ†ç»„ <= é€šè¿‡åµŒå¥—é…ç½®ç±»å®ç°
- åŠ¨æ€æ›´æ–°é…ç½®å¯¹è±¡ <= `props.autoLoad()`



## äºŒã€Mock æ¥å£

### éœ€æ±‚èƒŒæ™¯

ä¸ºä»€ä¹ˆéœ€è¦ï¼ŸRPC æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯è°ƒç”¨å…¶ä»–è¿œç¨‹æœåŠ¡ã€‚ä½†æ˜¯åœ¨å®é™…å¼€å‘å’Œæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å¯èƒ½æ— æ³•ç›´æ¥è®¿é—®çœŸå®çš„è¿œç¨‹æœåŠ¡ï¼Œæˆ–è€…è®¿é—®çœŸå®çš„è¿œç¨‹æœåŠ¡å¯èƒ½ä¼šäº§ç”Ÿä¸å¯æ§çš„å½±å“ï¼Œæ¯”å¦‚ç½‘ç»œå»¶è¿Ÿã€æœåŠ¡ä¸ç¨³å®šç­‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ä½¿ç”¨ Mock æœåŠ¡æ¥æ¨¡æ‹Ÿè¿œç¨‹æœåŠ¡çš„è¡Œä¸ºï¼Œä»¥ä¾¿è¿›è¡Œæ¥å£çš„æµ‹è¯•ã€å¼€å‘å’Œè°ƒè¯•ã€‚

### æ–¹æ¡ˆè®¾è®¡

ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œåˆ›å»ºä¸€ä¸ª**è°ƒç”¨æ–¹æ³•è¿”å›å›ºå®šå€¼**çš„å¯¹è±¡ã€‚

```properties
rpc.mock=false
```


#### TODO

- ä½¿ç”¨ Faker ç±»åº“ Mock æ•°æ®



## ä¸‰ã€åºåˆ—åŒ–

### éœ€æ±‚èƒŒæ™¯

åºåˆ—åŒ–å™¨çš„ä½œç”¨ï¼šæ— è®ºæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ï¼Œéƒ½ä¼šæ¶‰åŠåˆ°å‚æ•°çš„ä¼ è¾“ã€‚è€Œ Java å¯¹è±¡æ˜¯å­˜æ´»åœ¨  JVM è™šæ‹Ÿæœºä¸­çš„ï¼Œå¦‚æœæƒ³åœ¨å…¶ä»–ä½ç½®å­˜å‚¨å¹¶è®¿é—®ã€æˆ–è€…åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œå°±éœ€è¦è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

ç›®å‰å·²ç»å®ç°äº†åŸºäº Java åŸç”Ÿåºåˆ—åŒ–çš„åºåˆ—åŒ–å™¨ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªå®Œå–„çš„ RPC æ¡†æ¶ï¼Œè¿˜éœ€è¦å›ç­”å‡ ä¸ªé—®é¢˜ï¼š

1. æœ‰æ²¡æœ‰æ›´å¥½çš„åºåˆ—åŒ–å™¨å®ç°æ–¹å¼ï¼Ÿ
2. å¦‚ä½•è®©ä½¿ç”¨æ¡†æ¶çš„å¼€å‘è€…æŒ‡å®šä½¿ç”¨åºåˆ—åŒ–å™¨ï¼Ÿ
3. å¦‚ä½•è®©ä½¿ç”¨æ¡†æ¶çš„å¼€å‘è€…è‡ªå·±å®šåˆ¶åºåˆ—åŒ–å™¨ï¼Ÿ

### æ–¹æ¡ˆè®¾è®¡

#### å¸¸è§çš„åºåˆ—åŒ–å®ç°æ–¹å¼

1ï¼‰JSON

ä¼˜ç‚¹ï¼š

- å¯è¯»æ€§å¥½
- è¯­è¨€æ”¯æŒå¹¿æ³›

ç¼ºç‚¹ï¼š

- åºåˆ—åŒ–åæ•°æ®é‡è¾ƒå¤§
- ä¸èƒ½å¤Ÿå¾ˆå¥½çš„å¤„ç†å¤æ‚çš„æ•°æ®ç»“æ„å’Œå¾ªç¯å¼•ç”¨ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–è€…åºåˆ—åŒ–å¤±è´¥

2ï¼‰Hessian

ä¼˜ç‚¹ï¼š

- äºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œåºåˆ—åŒ–åçš„æ•°æ®é‡å°ï¼Œä¼ è¾“æ•ˆç‡é«˜
- è·¨è¯­è¨€ï¼Œé€‚åˆåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿›è¡ŒæœåŠ¡è°ƒç”¨

ç¼ºç‚¹ï¼š

- æ€§èƒ½è¾ƒ JSON ç•¥ä½ï¼Œå› ä¸ºéœ€è¦å°†å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶æ ¼å¼
- å¯¹è±¡å¿…é¡»è¦å®ç° Serializable æ¥å£ï¼Œé™åˆ¶äº†å¯åºåˆ—åŒ–çš„å¯¹è±¡èŒƒå›´

3ï¼‰Kryo

ä¼˜ç‚¹ï¼š

- é«˜æ€§èƒ½ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–é€Ÿåº¦å¿«
- æ”¯æŒå¾ªç¯å¼•ç”¨å’Œè‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œé€‚ç”¨äºå¤æ‚çš„å¯¹è±¡ç»“æ„
- æ— éœ€å®ç° Serializable æ¥å£ï¼Œå¯ä»¥åºåˆ—åŒ–ä»»æ„å¯¹è±¡

ç¼ºç‚¹ï¼š

- ä»…æ”¯æŒ Java
- å¯¹è±¡çš„åºåˆ—åŒ–æ ¼å¼å¯è¯»æ€§å·®

4ï¼‰Protobuf

ä¼˜ç‚¹ï¼š

- é«˜æ•ˆã€äºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œåºåˆ—åŒ–åçš„æ•°æ®é‡å°
- è·¨è¯­è¨€æ”¯æŒ
- æ”¯æŒç‰ˆæœ¬åŒ–å’Œå‘å‰ / å‘åå…¼å®¹æ€§

ç¼ºç‚¹ï¼š

- é…ç½®ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦å…ˆå®šä¹‰æ•°æ®ç»“æ„å’Œæ¶ˆæ¯æ ¼å¼
- å¯¹è±¡çš„åºåˆ—åŒ–æ ¼å¼ä¸æ˜“è¯»æ‡‚ï¼Œä¸ä¾¿äºè°ƒè¯•

#### åŠ¨æ€ä½¿ç”¨åºåˆ—åŒ–å™¨

åœ¨ä½¿ç”¨åºåˆ—åŒ–å™¨æ—¶ï¼Œæ ¹æ®é…ç½®æ¥è·å–ä¸åŒçš„åºåˆ—åŒ–å™¨ã€‚

#### è‡ªå®šä¹‰åºåˆ—åŒ–å™¨

æ€è·¯ï¼šRPC æ¡†æ¶èƒ½å¤Ÿè¯»å–åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»è·¯å¾„ï¼Œç„¶ååŠ è½½è¿™ä¸ªç±»ï¼Œä½œä¸º Serializer åºåˆ—åŒ–æ¥å£çš„å®ç°å³å¯ã€‚

å®ç°æ ¸å¿ƒæ­¥éª¤ï¼š[Java SPI](https://pdai.tech/md/java/advanced/java-advanced-spi.html)

#### è‡ªå®šä¹‰å®ç° SPI

1ï¼‰æŒ‡å®š SPI é…ç½®ç›®å½•

- ç³»ç»Ÿå†…ç½® SPI: `META-INF/rpc/system`
- ç”¨æˆ·è‡ªå®šä¹‰ SPI: `META-INF/rpc/custom`

2ï¼‰è‡ªå®šä¹‰åŠ è½½å™¨

- æ”¯æŒ `key=value`
- ç”¨æˆ·ç›®å½•ä¼˜å…ˆçº§æ›´é«˜

3ï¼‰æ”¯æŒæ‡’åŠ è½½

```java
public final class SerializerFactory {

    /**
     * è·å– Serializer
     *
     * @param key key
     * @return serializer
     */
    public static Serializer getSerializer(String key) {
        Serializer serializer;
        try {
            serializer = SpiLoader.getInstance(Serializer.class, key);
        } catch (NoSuchLoadClassException e) {
            init();
            serializer = SpiLoader.getInstance(Serializer.class, key);
        }
        return serializer;
    }

    public synchronized static void init() {
        SpiLoader.load(Serializer.class);
    }
}

// SpiLoader
public static <T> T getInstance(Class<T> loadClazz, String key) {
    String loadClazzName = loadClazz.getName();
    Map<String, Class<?>> keyImplClassMap = LOADER_MAP.get(loadClazzName);
    if (Objects.isNull(keyImplClassMap)) {
        throw new NoSuchLoadClassException(
            String.format("SpiLoader don't load %s,", loadClazz));
    }
    if (!keyImplClassMap.containskey(key)) {
        throw new NoSuchkeyException(
            String.format("%s has no key=%s impl class type,", loadClazz, key));
    }
    // ...
}
```



## å››ã€æ³¨å†Œä¸­å¿ƒ

### éœ€æ±‚èƒŒæ™¯

æ³¨å†Œä¸­å¿ƒæ˜¯ RPC æ¡†æ¶çš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œç›®çš„æ˜¯å¸®åŠ©æœåŠ¡æ¶ˆè´¹è€…è·å–åˆ°æœåŠ¡æä¾›è€…çš„è°ƒç”¨åœ°å€ï¼Œè€Œä¸æ˜¯å°†è°ƒç”¨åœ°å€ç¡¬ç¼–ç åˆ°é¡¹ç›®ä¸­ã€‚

![](assets/easy-rpc-registry-center.drawio.png)

### æ–¹æ¡ˆè®¾è®¡

#### æ³¨å†Œä¸­å¿ƒçš„æ ¸å¿ƒèƒ½åŠ›

1. æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨ï¼šé›†ä¸­çš„æ³¨å†Œä¿¡æ¯æ•°æ®å­˜å‚¨ã€è¯»å–å’Œå…±äº«
2. æœåŠ¡æ³¨å†Œï¼šæœåŠ¡æä¾›è€…ä¸ŠæŠ¥æœåŠ¡ä¿¡æ¯åˆ°æ³¨å†Œä¸­å¿ƒ
3. æœåŠ¡å‘ç°ï¼šæœåŠ¡æ¶ˆè´¹è€…ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡ä¿¡æ¯
4. å¿ƒè·³æ£€æµ‹ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡æä¾›è€…çš„å­˜æ´»çŠ¶æ€
5. æœåŠ¡æ³¨é”€ï¼šæ‰‹åŠ¨å‰”é™¤èŠ‚ç‚¹ã€æˆ–è€…è‡ªåŠ¨å‰”é™¤å¤±æ•ˆèŠ‚ç‚¹
6. å®¹é”™ã€ç¼“å­˜ã€â€¦â€¦

#### æŠ€æœ¯é€‰å‹

æ ¹æ®æ ¸å¿ƒèƒ½åŠ›è¿›è¡Œé€‰å‹ã€‚

**æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨**æ˜¯æœ€é‡è¦çš„ï¼Œæ­¤å¤–è¿˜éœ€è¦æœ‰æ•°æ®è¿‡æœŸã€æ•°æ®ç›‘å¬çš„èƒ½åŠ›ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè€ƒè™‘æ€§èƒ½ã€é«˜**å¯ç”¨æ€§**ã€é«˜**å¯é æ€§**ã€ç¨³å®šæ€§ã€æ•°æ®ä¸€è‡´æ€§ã€ç¤¾åŒºç”Ÿæ€å’Œæ´»è·ƒåº¦ã€‚

ä¸»æµçš„æ³¨å†Œä¸­å¿ƒä¸­é—´ä»¶ï¼š

- Zookeeper
- Redis
- Etcd âœ…
- â€¦â€¦

> ### Etcd
>
> Etcd æ˜¯ä¸€ä¸ª Go è¯­è¨€å®ç°çš„ã€å¼€æºçš„ã€åˆ†å¸ƒå¼ çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒä¸»è¦ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’Œåˆ†å¸ƒå¼é”ç­‰åœºæ™¯ã€‚Etcd é‡‡ç”¨ [Raft ä¸€è‡´æ€§ç®—æ³•](https://en.wikipedia.org/wiki/Raft_(algorithm))æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ï¼Œå…·æœ‰é«˜å¯ç”¨æ€§ã€å¼ºä¸€è‡´æ€§ã€åˆ†å¸ƒå¼ç‰¹æ€§ç­‰ç‰¹ç‚¹ã€‚
>
> #### Etcd æ•°æ®ç»“æ„
>
> 1ï¼‰keyï¼šEtcd ä¸­çš„åŸºæœ¬æ•°æ®å•å…ƒï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶åã€‚æ¯ä¸ªé”®éƒ½å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«å­é”®ï¼Œå½¢æˆç±»ä¼¼äºè·¯å¾„çš„å±‚æ¬¡ç»“æ„ï¼›ã€Œetcd ä¸­çš„æ¯ä¸ªé”®éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„ç‰ˆæœ¬å·ï¼Œç”¨äºè·Ÿè¸ªé”®çš„ä¿®æ”¹å†å²ã€
>
> 2ï¼‰Valueï¼šä¸é”®å…³è”çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯å­—ç¬¦ä¸²å½¢å¼ã€‚
>
> #### æ ¸å¿ƒç‰¹æ€§
>
> **1ï¼‰Leaseï¼ˆç§Ÿçº¦ï¼‰**ï¼šç”¨äºå¯¹é”®å€¼å¯¹è¿›è¡Œ TTL è¶…æ—¶è®¾ç½®ï¼Œå³è®¾ç½®é”®å€¼å¯¹çš„è¿‡æœŸæ—¶é—´ã€‚å½“ç§Ÿçº¦è¿‡æœŸæ—¶ï¼Œç›¸å…³çš„é”®å€¼å¯¹å°†è¢«è‡ªåŠ¨åˆ é™¤ï¼›
>
> **2ï¼‰Watchï¼ˆç›‘å¬ï¼‰ï¼š**å¯ä»¥ç›‘è§†ç‰¹å®šé”®çš„å˜åŒ–ï¼Œå½“é”®çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘ç›¸åº”çš„é€šçŸ¥ã€‚
>
> 
>
> #### å®‰è£…
>
> - [Etcd](https://etcd.io/docs/v3.5/install/)
> - [EtcdKeeper](https://github.com/evildecay/etcdkeeper)
>
> #### äº†è§£ Raft In Etcd
>
> - http://play.etcd.io/play
>
> 
>
> #### Etcd Java å®¢æˆ·ç«¯
>
> [jetcd](https://github.com/etcd-io/jetcd)
>
> ğŸ“¢æ³¨æ„ï¼šéœ€è¦ JDK11+
>
> 1. **kvClient**ï¼šç”¨äºå¯¹ etcd ä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ“ä½œã€‚é€šè¿‡ kvClient å¯ä»¥è¿›è¡Œè®¾ç½®å€¼ã€è·å–å€¼ã€åˆ é™¤å€¼ã€åˆ—å‡ºç›®å½•ç­‰æ“ä½œï¼›
> 2. **leaseClient**ï¼šç”¨äºç®¡ç† etcd çš„ç§Ÿçº¦æœºåˆ¶ã€‚ç§Ÿçº¦æ˜¯ etcd ä¸­çš„ä¸€ç§æ—¶é—´ç‰‡ï¼Œç”¨äºä¸ºé”®å€¼å¯¹åˆ†é…ç”Ÿå­˜æ—¶é—´ï¼Œå¹¶åœ¨ç§Ÿçº¦åˆ°æœŸæ—¶è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„é”®å€¼å¯¹ã€‚é€šè¿‡ leaseClient å¯ä»¥åˆ›å»ºã€è·å–ã€ç»­çº¦å’Œæ’¤é”€ç§Ÿçº¦ï¼›
> 3. **watchClient**ï¼šç”¨äºç›‘è§† etcd ä¸­é”®çš„å˜åŒ–ï¼Œå¹¶åœ¨é”®çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶æ¥æ”¶é€šçŸ¥ï¼›
> 4. clusterClientï¼šç”¨äºä¸ etcd é›†ç¾¤è¿›è¡Œäº¤äº’ï¼ŒåŒ…æ‹¬æ·»åŠ ã€ç§»é™¤ã€åˆ—å‡ºæˆå‘˜ã€è®¾ç½®é€‰ä¸¾ã€è·å–é›†ç¾¤çš„å¥åº·çŠ¶æ€ã€è·å–æˆå‘˜åˆ—è¡¨ä¿¡æ¯ç­‰æ“ä½œï¼›
> 5. authClientï¼šç”¨äºç®¡ç† etcd çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚é€šè¿‡ authClient å¯ä»¥æ·»åŠ ã€åˆ é™¤ã€åˆ—å‡ºç”¨æˆ·ã€è§’è‰²ç­‰èº«ä»½ä¿¡æ¯ï¼Œä»¥åŠæˆäºˆæˆ–æ’¤é”€ç”¨æˆ·æˆ–è§’è‰²çš„æƒé™ï¼›
> 6. maintenanceClientï¼šç”¨äºæ‰§è¡Œ etcd çš„ç»´æŠ¤æ“ä½œï¼Œå¦‚å¥åº·æ£€æŸ¥ã€æ•°æ®åº“å¤‡ä»½ã€æˆå‘˜ç»´æŠ¤ã€æ•°æ®åº“å¿«ç…§ã€æ•°æ®åº“å‹ç¼©ç­‰ï¼›
> 7. lockClientï¼šç”¨äºå®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ï¼Œé€šè¿‡ lockClient å¯ä»¥åœ¨ etcd ä¸Šåˆ›å»ºã€è·å–ã€é‡Šæ”¾é”ï¼Œèƒ½å¤Ÿè½»æ¾å®ç°å¹¶å‘æ§åˆ¶ï¼›
> 8. electionClientï¼šç”¨äºå®ç°åˆ†å¸ƒå¼é€‰ä¸¾åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ etcd ä¸Šåˆ›å»ºé€‰ä¸¾ã€æäº¤é€‰ç¥¨ã€ç›‘è§†é€‰ä¸¾ç»“æœç­‰ã€‚



#### å­˜å‚¨ç»“æ„è®¾è®¡

å­˜å‚¨ç»“æ„è®¾è®¡çš„å‡ ä¸ªè¦ç‚¹ï¼š

1. key çš„è®¾è®¡
2. Value çš„è®¾è®¡
3. key çš„è¿‡æœŸæ—¶é—´

ç”±äºä¸€ä¸ªæœåŠ¡å¯èƒ½æœ‰å¤šä¸ªæœåŠ¡æä¾›è€…ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œæ­¤å¤„å¯ä»¥æœ‰ä¸¤ç§ç»“æ„è®¾è®¡ï¼š

1ï¼‰å±‚çº§ç»“æ„ã€‚å°†æœåŠ¡ç†è§£ä¸ºæ–‡ä»¶å¤¹ã€å°†æœåŠ¡å¯¹åº”çš„å¤šä¸ªèŠ‚ç‚¹ç†è§£ä¸ºæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æœåŠ¡åç§°ï¼Œç”¨å‰ç¼€æŸ¥è¯¢çš„æ–¹å¼æŸ¥è¯¢åˆ°æŸä¸ªæœåŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚

ã€ğŸŒ°æ —å­ã€‘

é”®åçš„è§„åˆ™å¯ä»¥æ˜¯ `/ä¸šåŠ¡å‰ç¼€/æœåŠ¡å/æœåŠ¡èŠ‚ç‚¹åœ°å€`ï¼š

![](assets/easy-rpc-key-design-folder.drawio.png)

2ï¼‰åˆ—è¡¨ç»“æ„ã€‚å°†æ‰€æœ‰çš„æœåŠ¡èŠ‚ç‚¹ä»¥åˆ—è¡¨çš„å½¢å¼æ•´ä½“ä½œä¸º Valueï¼Œå³æœåŠ¡ä¸º key å…¶èŠ‚ç‚¹æ•´ä½“ä¸º Valueã€‚

ã€ğŸŒ°æ —å­ã€‘

![](assets/easy-rpc-key-design-list.drawio.png)

> é€‰æ‹©å“ªç§å­˜å‚¨ç»“æ„å‘¢ï¼Ÿ

è¿™ä¸ªè·ŸæŠ€æœ¯é€‰å‹æœ‰å…³ã€‚å¯¹äº ZooKeeper å’Œ Etcd è¿™ç§æ”¯æŒå±‚çº§æŸ¥è¯¢çš„ä¸­é—´ä»¶ï¼Œ**ç”¨ç¬¬ä¸€ç§ç»“æ„ä¼šæ›´æ¸…æ™°ï¼›**å¯¹äº Redisï¼Œç”±äºæœ¬èº«å°±æ”¯æŒåˆ—è¡¨æ•°æ®ç»“æ„ï¼Œå¯ä»¥é€‰æ‹©ç¬¬äºŒç§ç»“æ„ã€‚

æœ€åï¼Œä¸€å®šè¦**ç»™ key è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼Œæ¯”å¦‚é»˜è®¤ 30 ç§’è¿‡æœŸï¼Œè¿™æ ·å¦‚æœæœåŠ¡æä¾›è€…å®•æœºäº†ï¼Œä¹Ÿå¯ä»¥è¶…æ—¶åè‡ªåŠ¨ç§»é™¤ã€‚



#### å…·ä½“å®ç°ç»†èŠ‚

æŠ½è±¡æ¥å£ï¼š

```java
public interface Registry {


    /**
     * æ³¨å†Œä¸­å¿ƒåˆå§‹åŒ–
     *
     * @param config registry config
     */
    void init(RegistryConfig config);

    /**
     * æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡
     *
     * @param metadata æœåŠ¡å…ƒä¿¡æ¯
     */
    void register(ServiceMetadata metadata) throws Exception;

    /**
     * æœåŠ¡ç«¯æ³¨é”€æœåŠ¡
     *
     * @param metadata æœåŠ¡å…ƒä¿¡æ¯
     */
    void deregister(ServiceMetadata metadata);

    /**
     * æ¶ˆè´¹ç«¯è·å–æŸæœåŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒæœåŠ¡å‘ç°
     *
     * @param serviceKey æœåŠ¡é”®
     * @return æŸæœåŠ¡ä¸‹çš„æ‰€æœ‰æœåŠ¡èŠ‚ç‚¹å…ƒä¿¡æ¯
     */
    List<ServiceMetadata> discovery(String serviceKey);


    /**
     * æ³¨å†Œä¸­å¿ƒé”€æ¯
     */
    void destroy();

}
```

æœ€åï¼Œä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨è‡ªå®šä¹‰ SPI å®ç°æ³¨å†Œä¸­å¿ƒçš„æ‰©å±•ï¼ˆåŒ Serializerï¼‰ã€‚
